<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Responses</title>
    <!-- CSS de Bootstrap -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
<div class="container-fluid mt-5">
    <div class="row">
        <div class="col-md-4">

            <div class="card">
                <div class="card-body">
                    <h1 class="text-center mb-4">Upload Image</h1>
                    <!-- Formulario de carga de imagen -->
                    <form method="post" action="/responses" enctype="multipart/form-data" class="mb-5">
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="customFile" name="image" required>
                            <label class="custom-file-label" for="customFile">Choose file</label>
                        </div>
                        <button type="submit" class="btn btn-primary btn-block mt-4">Upload</button>
                    </form>

                </div>
            </div>
            <div class="card mt-4">
                <div class="card-body">
                    <h1 class="text-center mb-4">Buscar Respuestas</h1>
                    <!-- Formulario de búsqueda -->
                    <form id="searchForm" class="mb-5">
                        <div class="row">
                            <div class="col-md-6 form-group">
                                <label for="operationCode">Código de Operación</label>
                                <input type="text" class="form-control" id="operationCode" name="operationCode">
                            </div>
                            <div class="col-md-6 form-group">
                                <label for="recipient">Destinatario</label>
                                <input type="text" class="form-control" id="recipient" name="recipient">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 form-group">
                                <label for="date">Fecha</label>
                                <input type="date" class="form-control" id="date" name="date">
                            </div>
                            <div class="col-md-4 form-group">
                                <label for="amount">Monto</label>
                                <input type="number" class="form-control" id="amount" name="amount">
                            </div>
                            <div class="col-md-4 form-group">
                                <label for="state">Estado</label>
                                <select class="form-control" id="state" name="state">
                                    <option value="">Todos</option>
                                    <option value="ACCEPTED">Aceptado</option>
                                    <option value="REJECTED">Rechazado</option>
                                    <option value="PENDING">Pendiente</option>
                                </select>
                            </div>
                        </div>
                        <button type="button" id="filterButton" class="btn btn-primary btn-block mt-4">Filtrar</button>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <h1 class="text-center mb-4">Responses</h1>
                    <!-- Tabla de respuestas -->
                    <table class="table table-striped">
                        <thead>
                        <tr>
                            <th>N.</th>
                            <th>Método de Pago</th>
                            <th>Monto</th>
                            <th>Fecha</th>
                            <th>Destinatario</th>
                            <th>Código de Operación</th>
                            <th>Estado</th>
                            <th>Imagen</th>
                            <th>Función</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="response : ${responses}">
                            <td th:text="${response.id}"></td>
                            <td th:text="${response.entidad}"></td>
                            <td th:text="${response.monto}"></td>
                            <td th:text="${response.fechaString}"></td>
                            <td th:text="${response.destinatario}"></td>
                            <td th:text="${response.codigoOperacion}"></td>
                            <td th:text="${response.state}"></td>
                            <td>
                                <button type="button" class="btn btn-primary" data-toggle="modal"
                                        data-target="#imageModal"
                                        th:data-img="'data:image/png;base64,'+${response.imgBase64}">
                                    Boucher
                                </button>
                            </td>
                            <td>
                                <button type="button" class="btn btn-success state-btn" th:data-id="${response.id}"
                                        th:onclick="'changeState(this, \'ACCEPTED\')'">
                                    Aceptar
                                </button>
                                <button type="button" class="btn btn-danger state-btn" th:data-id="${response.id}"
                                        th:onclick="'changeState(this, \'REJECTED\')'">
                                    Rechazar
                                </button>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-body">
                <img id="modalImage" src="" class="img-fluid"/>
            </div>
        </div>
    </div>
</div>

<!-- JS de Bootstrap -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<!-- JS para cambiar la imagen del modal -->
<script>
    $(document).ready(function() {
        $('.btn').on('click', function() {
            var imageSrc = $(this).data('img');
            $('#modalImage').attr('src', imageSrc);
        });
    });

    document.querySelector('.custom-file-input').addEventListener('change', function(e) {
        var fileName = document.getElementById("customFile").files[0].name;
        var nextSibling = e.target.nextElementSibling
        nextSibling.innerText = fileName
    });
</script>

<script>
    function changeState(btn, newState) {
        var id = btn.dataset.id;

        fetch('/api/responses/' + id + '/state', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: newState,
        })
        .then(function(response) {
            return response.json();
        })
        .then(function(response) {
            if (response.state) {
                // Actualiza el estado en la interfaz de usuario
                var row = btn.parentElement;
                var stateCell = row.querySelector('td:nth-child(6)');
                stateCell.innerText = newState;

                // Actualiza los botones
                var acceptButtons = row.querySelectorAll('.btn-success');
                var rejectButtons = row.querySelectorAll('.btn-danger');
                if (newState === 'ACCEPTED') {
                    if (acceptButton) acceptButton.style.display = 'none';
                    if (rejectButton) rejectButton.style.display = '';
                } else if (newState === 'REJECTED') {
                    if (acceptButton) acceptButton.style.display = '';
                    if (rejectButton) rejectButton.style.display = 'none';
                } else if (newState === 'PENDING') {
                    if (acceptButton) acceptButton.style.display = '';
                    if (rejectButton) rejectButton.style.display = 'none';
                }
            } else {
                console.error('Error updating state');
            }
        });
    }
</script>

<script>
    // Obtén los campos de entrada y las filas de la tabla
    var operationCodeInput = document.getElementById('operationCode');
    var recipientInput = document.getElementById('recipient');
    var dateInput = document.getElementById('date');
    var amountInput = document.getElementById('amount');
    var stateInput = document.getElementById('state');
    var rows = Array.from(document.querySelectorAll('table tbody tr'));

    // Obtén el botón de filtrado
    var filterButton = document.getElementById('filterButton');

    // Agrega un evento de escucha al botón de filtrado
    filterButton.addEventListener('click', filterRows);

    function filterRows() {
        // Obtén los valores actuales de los campos de entrada
        var operationCode = operationCodeInput.value.toLowerCase();
        var recipient = recipientInput.value.toLowerCase();
        var date = dateInput.value;
        var amount = amountInput.value;
        var state = stateInput.value.toLowerCase();

        // Filtra las filas de la tabla
        rows.forEach(function(row) {
            var operationCodeCell = row.querySelector('td:nth-child(6)').innerText.toLowerCase();
            var recipientCell = row.querySelector('td:nth-child(5)').innerText.toLowerCase();
            var dateCell = row.querySelector('td:nth-child(4)').innerText;
            var amountCell = row.querySelector('td:nth-child(3)').innerText;
            var stateCell = row.querySelector('td:nth-child(7)').innerText.toLowerCase();

            var shouldDisplay = true;

            if (operationCode && operationCode !== operationCodeCell) {
                shouldDisplay = false;
            }
            if (recipient && recipient !== recipientCell) {
                shouldDisplay = false;
            }
            if (date && date !== dateCell) {
                shouldDisplay = false;
            }
            if (amount && amount !== amountCell) {
                shouldDisplay = false;
            }
            if (state && state !== stateCell) {
                shouldDisplay = false;
            }

            row.style.display = shouldDisplay ? '' : 'none';
        });
    }
</script>
</body>
</html>